<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plagiarism Checker - Dr. Kolonsky Algorithm</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #1976d2;
            --primary-dark: #1565c0;
            --secondary: #424242;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --light: #f5f5f5;
            --dark: #212121;
            --border: #e0e0e0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 95%;
            max-width: 1400px;
            min-height: 90vh;
            display: flex;
            overflow: hidden;
        }
        
        .sidebar {
            background: var(--dark);
            width: 280px;
            padding: 30px 20px;
            color: white;
            display: flex;
            flex-direction: column;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .logo h1 {
            font-size: 24px;
            margin-bottom: 5px;
            color: white;
        }
        
        .logo p {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
        }
        
        .nav-menu {
            list-style: none;
            flex: 1;
        }
        
        .nav-item {
            margin-bottom: 5px;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .nav-link:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .nav-link.active {
            background: var(--primary);
            color: white;
        }
        
        .nav-icon {
            margin-right: 15px;
            font-size: 20px;
        }
        
        .user-info {
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }
        
        .user-info .username {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .user-info .role {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
        }
        
        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .section-header {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 28px;
            color: var(--dark);
            margin-bottom: 10px;
        }
        
        .section-subtitle {
            color: #666;
            font-size: 14px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border-left: 4px solid var(--primary);
        }
        
        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: var(--dark);
        }
        
        .stat-card .label {
            color: #999;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .upload-area {
            border: 3px dashed var(--border);
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s;
            background: var(--light);
        }
        
        .upload-area.dragover {
            border-color: var(--primary);
            background: rgba(25, 118, 210, 0.05);
        }
        
        .upload-icon {
            font-size: 60px;
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(25, 118, 210, 0.3);
        }
        
        .btn-secondary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .parameters {
            background: var(--light);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .parameter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 500;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .progress-bar {
            background: var(--light);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            height: 30px;
            display: none;
        }
        
        .progress-bar.active {
            display: block;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            height: 100%;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .log-container {
            background: #1e1e1e;
            color: #0f0;
            font-family: 'Courier New', monospace;
            padding: 20px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
            font-size: 12px;
            display: none;
        }
        
        .log-container.active {
            display: block;
        }
        
        .log-entry {
            margin-bottom: 5px;
            opacity: 0;
            animation: fadeIn 0.3s forwards;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .results-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .results-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .results-table th {
            background: var(--dark);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 500;
            font-size: 14px;
            text-transform: uppercase;
        }
        
        .results-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .results-table tr:hover {
            background: var(--light);
        }
        
        .similarity-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        
        .similarity-high { background: var(--danger); }
        .similarity-medium { background: var(--warning); }
        .similarity-low { background: var(--success); }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }
        
        .modal-title {
            font-size: 24px;
            color: var(--dark);
        }
        
        .modal-body {
            margin: 20px 0;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 30px;
        }
        
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .login-container.hidden {
            display: none;
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        
        .login-logo {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        .login-title {
            font-size: 28px;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .login-subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert.show {
            display: block;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .uploaded-files {
            margin-top: 20px;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: var(--light);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .file-name {
            font-size: 14px;
            color: var(--dark);
        }
        
        .file-size {
            font-size: 12px;
            color: #666;
        }
        
        .archives-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }
        
        .archive-year {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .archive-year h3 {
            color: var(--dark);
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .archive-list {
            display: grid;
            gap: 10px;
        }
        
        .archive-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: var(--light);
            border-radius: 8px;
        }
        
        .archive-name {
            font-weight: 500;
            color: var(--dark);
        }
        
        .archive-info {
            font-size: 12px;
            color: #666;
        }

        .experiments-panel {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .experiments-panel h3 {
            margin-bottom: 15px;
            font-size: 20px;
            color: var(--dark);
        }

        .experiment-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .experiment-tag {
            background: var(--light);
            border: 1px solid var(--border);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            color: var(--secondary);
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .experiment-empty {
            color: #999;
            font-size: 13px;
        }

        .hidden {
            display: none !important;
        }

        .error-text {
            color: var(--danger);
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }

        .modal .error-text {
            display: block;
            min-height: 18px;
        }

        .form-hint {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }

        .file-manager {
            display: none;
        }
        
        .admin .file-manager {
            display: block;
        }
        
        .tree-view {
            background: var(--light);
            border-radius: 10px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .tree-item {
            padding: 8px 0;
            cursor: pointer;
            user-select: none;
        }
        
        .tree-item:hover {
            background: rgba(25, 118, 210, 0.05);
        }
        
        .tree-folder::before {
            content: '📁 ';
        }
        
        .tree-file::before {
            content: '📄 ';
        }
        
        .tree-children {
            margin-left: 20px;
        }
        
        .spinner {
            border: 3px solid var(--light);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <div class="login-logo">🔍</div>
            <h1 class="login-title">Plagiarism Checker</h1>
            <p class="login-subtitle">Dr. Kolonsky Algorithm</p>
            
            <div class="alert alert-error" id="loginError"></div>
            
            <form id="loginForm">
                <div class="form-group">
                    <input type="text" id="username" placeholder="Username" required>
                </div>
                <div class="form-group">
                    <input type="password" id="password" placeholder="Password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
            </form>
            
            <p style="margin-top: 20px; color: #666; font-size: 12px;">
                Default: admin/admin123 or teacher/teacher123
            </p>
        </div>
    </div>
    
    <!-- Main Application -->
    <div class="container" id="mainApp" style="display: none;">
        <aside class="sidebar">
            <div class="logo">
                <h1>🔍 PlagCheck</h1>
                <p>Dr. Kolonsky Algorithm</p>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link active" data-section="dashboard">
                        <span class="nav-icon">📊</span>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="check">
                        <span class="nav-icon">🔍</span>
                        <span>New Check</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="history">
                        <span class="nav-icon">📜</span>
                        <span>History</span>
                    </a>
                </li>
                <li class="nav-item admin-only" style="display: none;">
                    <a class="nav-link" data-section="admin">
                        <span class="nav-icon">⚙️</span>
                        <span>Admin Panel</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="logoutBtn">
                        <span class="nav-icon">🚪</span>
                        <span>Logout</span>
                    </a>
                </li>
            </ul>
            
            <div class="user-info">
                <div class="username" id="currentUsername">-</div>
                <div class="role" id="currentRole">-</div>
            </div>
        </aside>
        
        <main class="main-content">
            <!-- Dashboard Section -->
            <section class="section active" id="dashboard">
                <div class="section-header">
                    <h2 class="section-title">Dashboard</h2>
                    <p class="section-subtitle">System overview and archive database</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Archives</h3>
                        <div class="value" id="totalArchives">0</div>
                        <div class="label">in database</div>
                    </div>
                    <div class="stat-card">
                        <h3>Academic Years</h3>
                        <div class="value" id="totalYears">-</div>
                        <div class="label" id="yearsLabel">No academic year data available</div>
                    </div>
                </div>

                <div class="experiments-panel">
                    <h3>Available Experiments</h3>
                    <div class="experiment-tags" id="experimentsList">
                        <span class="experiment-empty">No experiments in the library yet</span>
                    </div>
                </div>
            </section>
            
            <!-- New Check Section -->
            <section class="section" id="check">
                <div class="section-header">
                    <h2 class="section-title">New Plagiarism Check</h2>
                    <p class="section-subtitle">Upload files and configure check parameters</p>
                </div>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">📁</div>
                    <p style="font-size: 18px; margin-bottom: 10px;">Drag & drop archive here</p>
                    <p style="color: #666; margin-bottom: 20px;">or</p>
                    <input type="file" id="fileInput" style="display: none;" accept=".zip" multiple>
                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                        Choose Files
                    </button>
                    <p style="color: #999; margin-top: 15px; font-size: 12px;">
                        Supported format: YYYY.NN_experiment.zip (e.g., 2024.01_DC.zip)
                    </p>
                </div>
                
                <div class="uploaded-files" id="uploadedFiles"></div>
                
                <div class="parameters">
                    <h3 style="margin-bottom: 20px;">Check Parameters</h3>
                    <div class="parameter-group">
                        <div class="form-group">
                            <label>Similarity Threshold (%)</label>
                            <input type="number" id="threshold" value="95" min="50" max="100">
                        </div>
                        <div class="form-group">
                            <label>Days Between Submissions</label>
                            <input type="number" id="daysDiff" value="14" min="0">
                        </div>
                        <div class="form-group">
                            <label>Max Copied Images</label>
                            <input type="number" id="imagesCopied" value="2" min="0">
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" id="startCheckBtn">Start Check</button>
                        <button class="btn btn-secondary" id="clearFilesBtn">Clear Files</button>
                    </div>
                </div>
                
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
                
                <div id="progressMessage" style="text-align: center; margin: 10px 0; color: #666;"></div>
                
                <div class="log-container" id="logContainer"></div>
                
                <div id="resultsSection" style="display: none;">
                    <h3 style="margin: 30px 0 20px;">Check Results</h3>
                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-success" id="downloadResultsBtn" disabled>
                            📥 Download Results
                        </button>
                        <p class="form-hint" id="resultsHint" style="margin-top: 8px;">The archive includes the compare.py report and highlighted files.</p>
                    </div>
                    <div class="results-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Student 1</th>
                                    <th>Student 2</th>
                                    <th>Similarity</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTable"></tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <!-- History Section -->
            <section class="section" id="history">
                <div class="section-header">
                    <h2 class="section-title">Check History</h2>
                    <p class="section-subtitle">View previous plagiarism checks</p>
                </div>
                
                <div class="results-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>File</th>
                                <th>Status</th>
                                <th>Matches</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable"></tbody>
                    </table>
                </div>
            </section>
            
            <!-- Admin Section -->
            <section class="section" id="admin">
                <div class="section-header">
                    <h2 class="section-title">Admin Panel</h2>
                    <p class="section-subtitle">Manage users and archive library</p>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 20px;">User Management</h3>
                    <button class="btn btn-primary" id="addUserBtn">+ Add User</button>
                    
                    <div class="results-table" style="margin-top: 20px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable"></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="file-manager">
                    <h3 style="margin-bottom: 20px;">Archive Library Manager</h3>
                    <div style="margin-bottom: 20px;">
                        <input type="file" id="libraryFileInput" accept=".zip" multiple style="display: none;">
                        <button class="btn btn-primary" onclick="document.getElementById('libraryFileInput').click()">
                            📁 Upload Archives to Library
                        </button>
                        <button class="btn btn-secondary" id="refreshLibraryBtn">
                            🔄 Refresh
                        </button>
                    </div>
                    
                    <div class="tree-view" id="libraryTree">
                        <div class="spinner"></div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <!-- File Rename Modal -->
    <div class="modal" id="renameModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Fix Archive Name</h2>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: #666;">
                    The file name doesn't match the required format. Please provide the following information:
                </p>
                <div class="form-group">
                    <label>Current filename:</label>
                    <p id="currentFilename" style="font-weight: bold; color: var(--dark);"></p>
                </div>
                <div class="form-group">
                    <label>Academic Year</label>
                    <select id="academicYear"></select>
                    <input type="text" id="customAcademicYear" class="hidden" placeholder="Enter year, e.g. 2024-2025">
                    <p class="form-hint">Select an existing academic year or choose “Other” to type a new one.</p>
                </div>
                <div class="form-group">
                    <label>Semester</label>
                    <select id="semester">
                        <option value="01">01 (Fall)</option>
                        <option value="02">02 (Spring)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Experiment</label>
                    <select id="experimentType"></select>
                    <input type="text" id="customExperiment" class="hidden" placeholder="Enter experiment code">
                    <p class="form-hint">Letters, numbers and “-” only. Existing experiments are pre-filled.</p>
                </div>
                <p id="renameError" class="error-text"></p>
                <div class="form-group">
                    <label>New filename:</label>
                    <p id="newFilename" style="font-weight: bold; color: var(--primary);"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelRenameBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmRenameBtn">Rename & Upload</button>
            </div>
        </div>
    </div>
    
    <!-- User Management Modal -->
    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="userModalTitle">Add User</h2>
            </div>
            <div class="modal-body">
                <p id="userModalError" class="error-text"></p>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="userUsername" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="userPassword" placeholder="Leave empty to keep current" >
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="userRole">
                        <option value="teacher">Teacher</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelUserBtn">Cancel</button>
                <button class="btn btn-primary" id="saveUserBtn">Save</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentUser = null;
        let currentCheckId = null;
        let uploadedFiles = [];
        let availableExperiments = [];
        let availableAcademicYears = [];
        let yearCodeMap = {};
        let pendingFile = null;
        let userModalMode = 'create';
        let editingUserId = null;
        
        // Check saved session
        function checkSession() {
            const savedUser = localStorage.getItem('username');
            const savedToken = localStorage.getItem('token');
            
            if (savedUser && savedToken) {
                fetch('/session/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: savedUser, token: savedToken })
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        currentUser = { username: savedUser, role: localStorage.getItem('role'), token: savedToken };
                        showMainApp();
                    }
                });
            }
        }
        
        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data;
                    localStorage.setItem('username', data.username);
                    localStorage.setItem('role', data.role);
                    localStorage.setItem('token', data.token);
                    showMainApp();
                } else {
                    showLoginError('Invalid username or password');
                }
            } catch (error) {
                showLoginError('Connection error');
            }
        });
        
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            setTimeout(() => errorDiv.classList.remove('show'), 3000);
        }
        
        function showMainApp() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('mainApp').style.display = 'flex';
            document.getElementById('currentUsername').textContent = currentUser.username;
            document.getElementById('currentRole').textContent = currentUser.role;
            
            if (currentUser.role === 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                document.body.classList.add('admin');
            }
            
            loadDashboard();
            loadHistory();
            if (currentUser.role === 'admin') {
                loadUsers();
                loadLibraryTree();
            }
        }
        
        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await fetch('/logout', { method: 'POST' });
            localStorage.clear();
            location.reload();
        });
        
        function activateSection(sectionId) {
            document.querySelectorAll('.nav-link[data-section]').forEach(link => {
                if (link.dataset.section === sectionId) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

            document.querySelectorAll('.section').forEach(section => {
                if (section.id === sectionId) {
                    section.classList.add('active');
                } else {
                    section.classList.remove('active');
                }
            });
        }

        // Navigation
        document.querySelectorAll('.nav-link[data-section]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                activateSection(link.dataset.section);
            });
        });
        
        // Load dashboard
        async function loadDashboard() {
            try {
                const response = await fetch('/archives/info');
                const data = await response.json();

                if (data.success && data.info) {
                    const info = data.info;

                    availableExperiments = Array.isArray(info.experiments) ? info.experiments.slice().sort() : [];
                    availableAcademicYears = Array.isArray(info.available_years) ? info.available_years.slice().sort() : [];
                    yearCodeMap = info.year_codes || {};

                    document.getElementById('totalArchives').textContent = info.total_archives || 0;

                    const yearRangeEl = document.getElementById('totalYears');
                    const yearRangeLabel = document.getElementById('yearsLabel');
                    const range = info.year_range;
                    if (range && range.start && range.end) {
                        yearRangeEl.textContent = `${range.start} – ${range.end}`;
                        yearRangeLabel.textContent = 'Academic years covered';
                    } else {
                        yearRangeEl.textContent = 'No data';
                        yearRangeLabel.textContent = 'Upload archives to build coverage';
                    }

                    const experimentsList = document.getElementById('experimentsList');
                    experimentsList.innerHTML = '';
                    if (availableExperiments.length === 0) {
                        experimentsList.innerHTML = '<span class="experiment-empty">No experiments in the library yet</span>';
                    } else {
                        availableExperiments.forEach(exp => {
                            const badge = document.createElement('span');
                            badge.className = 'experiment-tag';
                            badge.textContent = exp;
                            experimentsList.appendChild(badge);
                        });
                    }

                    updateRenameSelectors();
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        function getSuggestedAcademicYears() {
            const suggestions = new Set(availableAcademicYears.filter(Boolean));
            const now = new Date();
            const month = now.getMonth();
            const currentStart = month >= 7 ? now.getFullYear() : now.getFullYear() - 1;
            suggestions.add(`${currentStart}-${currentStart + 1}`);
            suggestions.add(`${currentStart + 1}-${currentStart + 2}`);
            return Array.from(suggestions).sort();
        }

        function updateRenameSelectors() {
            const yearSelect = document.getElementById('academicYear');
            const experimentSelect = document.getElementById('experimentType');
            if (!yearSelect || !experimentSelect) {
                return;
            }

            const yearOptions = getSuggestedAcademicYears();
            yearSelect.innerHTML = '';

            if (yearOptions.length) {
                yearOptions.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });
            } else {
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = '-- Select --';
                yearSelect.appendChild(placeholder);
            }

            const customYearOption = document.createElement('option');
            customYearOption.value = '__custom__';
            customYearOption.textContent = 'Other…';
            yearSelect.appendChild(customYearOption);

            if (yearOptions.length) {
                yearSelect.value = yearOptions[0];
                toggleCustomAcademicYear(false);
            } else {
                yearSelect.value = '__custom__';
                toggleCustomAcademicYear(true);
            }

            experimentSelect.innerHTML = '';
            if (availableExperiments.length) {
                availableExperiments.forEach(exp => {
                    const option = document.createElement('option');
                    option.value = exp;
                    option.textContent = exp;
                    experimentSelect.appendChild(option);
                });
            }
            const customExperimentOption = document.createElement('option');
            customExperimentOption.value = '__custom__';
            customExperimentOption.textContent = 'Other…';
            experimentSelect.appendChild(customExperimentOption);

            if (availableExperiments.length) {
                experimentSelect.value = availableExperiments[0];
                toggleCustomExperiment(false);
            } else {
                experimentSelect.value = '__custom__';
                toggleCustomExperiment(true);
            }

            document.getElementById('customAcademicYear').value = '';
            document.getElementById('customExperiment').value = '';

            updateNewFilename();
        }

        function normaliseAcademicYearLabel(label) {
            if (!label) {
                return '';
            }
            const trimmed = label.trim();
            const digits = trimmed.replace(/[^0-9]/g, '');

            if (digits.length >= 8) {
                const start = digits.slice(0, 4);
                const end = digits.slice(-4);
                return `${start}-${end}`;
            }

            if (digits.length === 4) {
                if (digits.startsWith('19') || digits.startsWith('20')) {
                    const start = digits;
                    return `${start}-${parseInt(start, 10) + 1}`;
                }
                const start = `20${digits.slice(0, 2)}`;
                const end = `20${digits.slice(2)}`;
                return `${start}-${end}`;
            }

            if (digits.length === 2) {
                const start = `20${digits}`;
                return `${start}-${parseInt(start, 10) + 1}`;
            }

            return trimmed;
        }

        function toggleCustomAcademicYear(show) {
            const input = document.getElementById('customAcademicYear');
            if (!input) return;
            if (show) {
                input.classList.remove('hidden');
                input.focus();
            } else {
                input.classList.add('hidden');
                input.value = '';
            }
        }

        function toggleCustomExperiment(show) {
            const input = document.getElementById('customExperiment');
            if (!input) return;
            if (show) {
                input.classList.remove('hidden');
                input.focus();
            } else {
                input.classList.add('hidden');
                input.value = '';
            }
        }

        function sanitizeExperimentName(value) {
            return value.trim().replace(/\s+/g, '-').replace(/[^A-Za-z0-9-]/g, '');
        }

        function getAcademicYearLabel() {
            const select = document.getElementById('academicYear');
            if (!select) return '';
            if (select.value === '__custom__') {
                return normaliseAcademicYearLabel(document.getElementById('customAcademicYear').value);
            }
            return normaliseAcademicYearLabel(select.value);
        }

        function getYearCodeForLabel(label) {
            if (!label) {
                return '';
            }
            const normalisedLabel = normaliseAcademicYearLabel(label);
            if (yearCodeMap && yearCodeMap[normalisedLabel]) {
                return yearCodeMap[normalisedLabel];
            }
            if (yearCodeMap && yearCodeMap[label]) {
                return yearCodeMap[label];
            }
            const digits = normalisedLabel.replace(/[^0-9]/g, '');
            if (digits.length >= 8) {
                return digits.slice(0, 4);
            }
            if (digits.length === 4) {
                if (digits.startsWith('19') || digits.startsWith('20')) {
                    return digits;
                }
                return `20${digits.slice(0, 2)}`;
            }
            if (digits.length === 2) {
                return `20${digits}`;
            }
            return '';
        }

        function showRenameError(message) {
            const errorEl = document.getElementById('renameError');
            if (!errorEl) return;
            errorEl.textContent = message || '';
            errorEl.style.display = message ? 'block' : 'none';
        }

        function updateNewFilename() {
            const semester = document.getElementById('semester').value;
            const experimentSelect = document.getElementById('experimentType');
            const customExperimentInput = document.getElementById('customExperiment');

            let experiment = '';
            if (experimentSelect.value === '__custom__') {
                experiment = sanitizeExperimentName(customExperimentInput.value);
            } else {
                experiment = experimentSelect.value;
            }

            const yearLabel = getAcademicYearLabel();
            const yearCode = getYearCodeForLabel(yearLabel);

            const filename = yearCode && semester && experiment
                ? `${yearCode}.${semester}_${experiment}.zip`
                : '—';

            document.getElementById('newFilename').textContent = filename;
            if (filename !== '—') {
                showRenameError('');
            }
        }

        function closeRenameModal() {
            const modal = document.getElementById('renameModal');
            modal.classList.remove('active');
            document.getElementById('customAcademicYear').value = '';
            document.getElementById('customExperiment').value = '';
            showRenameError('');
            pendingFile = null;
        }

        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
            e.target.value = '';
        });

        async function handleFiles(files) {
            for (const file of Array.from(files)) {
                if (!file.name.toLowerCase().endsWith('.zip')) {
                    alert('Please upload only ZIP files');
                    continue;
                }

                try {
                    const response = await fetch('/validate_filename', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filename: file.name })
                    });
                    const validation = await response.json();

                    if (validation.success && validation.valid) {
                        uploadFile(file);
                    } else if (validation.success) {
                        if (Array.isArray(validation.available_experiments)) {
                            availableExperiments = validation.available_experiments.slice().sort();
                        }
                        if (Array.isArray(validation.available_years)) {
                            availableAcademicYears = validation.available_years.slice().sort();
                        }
                        if (validation.year_codes) {
                            yearCodeMap = validation.year_codes;
                        }
                        showRenameModal(file);
                    } else {
                        alert('Unable to validate filename. Please try again.');
                    }
                } catch (error) {
                    console.error('Validation error:', error);
                    alert('Unable to validate filename. Please try again.');
                }
            }
        }

        function showRenameModal(file) {
            pendingFile = file;
            const modal = document.getElementById('renameModal');
            document.getElementById('currentFilename').textContent = file.name;
            showRenameError('');
            updateRenameSelectors();
            modal.classList.add('active');
        }

        document.getElementById('academicYear').addEventListener('change', (e) => {
            toggleCustomAcademicYear(e.target.value === '__custom__');
            updateNewFilename();
        });
        document.getElementById('customAcademicYear').addEventListener('input', updateNewFilename);
        document.getElementById('semester').addEventListener('change', updateNewFilename);
        document.getElementById('experimentType').addEventListener('change', (e) => {
            toggleCustomExperiment(e.target.value === '__custom__');
            updateNewFilename();
        });
        document.getElementById('customExperiment').addEventListener('input', updateNewFilename);

        document.getElementById('confirmRenameBtn').addEventListener('click', () => {
            if (pendingFile) {
                const yearLabel = getAcademicYearLabel();
                const sem = document.getElementById('semester').value;
                const experimentSelect = document.getElementById('experimentType');
                const customExperimentInput = document.getElementById('customExperiment');

                if (!yearLabel) {
                    showRenameError('Please select or enter the academic year.');
                    return;
                }

                const yearCode = getYearCodeForLabel(yearLabel);
                if (!yearCode) {
                    showRenameError('Academic year must be in format YYYY-YYYY.');
                    return;
                }

                let experiment = '';
                if (experimentSelect.value === '__custom__') {
                    experiment = sanitizeExperimentName(customExperimentInput.value);
                    if (!experiment) {
                        showRenameError('Please enter the experiment code.');
                        return;
                    }
                    if (!availableExperiments.includes(experiment)) {
                        availableExperiments.push(experiment);
                        availableExperiments.sort();
                    }
                } else {
                    experiment = experimentSelect.value;
                }

                const newName = `${yearCode}.${sem}_${experiment}.zip`;
                const renamedFile = new File([pendingFile], newName, { type: pendingFile.type });
                uploadFile(renamedFile);
                const normalisedYear = normaliseAcademicYearLabel(yearLabel);
                if (!availableAcademicYears.includes(normalisedYear)) {
                    availableAcademicYears.push(normalisedYear);
                    availableAcademicYears.sort();
                }
                closeRenameModal();
            }
        });

        document.getElementById('cancelRenameBtn').addEventListener('click', () => {
            closeRenameModal();
        });
        
        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (data.success) {
                    uploadedFiles = uploadedFiles.concat(data.files);
                    displayUploadedFiles();
                }
            } catch (error) {
                console.error('Upload error:', error);
            }
        }
        
        function displayUploadedFiles() {
            const container = document.getElementById('uploadedFiles');
            if (uploadedFiles.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = '<h4 style="margin-bottom: 10px;">Uploaded Files:</h4>';
            uploadedFiles.forEach(file => {
                container.innerHTML += `
                    <div class="file-item">
                        <div>
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${(file.size / 1024).toFixed(2)} KB</div>
                        </div>
                    </div>
                `;
            });
        }
        
        // Clear files
        document.getElementById('clearFilesBtn').addEventListener('click', async () => {
            await fetch('/clear_uploads', { method: 'POST' });
            uploadedFiles = [];
            displayUploadedFiles();
        });
        
        // Start check
        document.getElementById('startCheckBtn').addEventListener('click', async () => {
            if (uploadedFiles.length === 0) {
                alert('Please upload files first');
                return;
            }
            
            const parameters = {
                threshold: document.getElementById('threshold').value,
                days_diff: document.getElementById('daysDiff').value,
                images_copied: document.getElementById('imagesCopied').value,
                // Hidden parameters with defaults
                ngram_min: 2,
                ngram_max: 5,
                min_pixel_size: 200
            };
            
            try {
                const response = await fetch('/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(parameters)
                });
                
                const data = await response.json();
                if (data.success) {
                    currentCheckId = data.check_id;
                    startProgressTracking();
                }
            } catch (error) {
                console.error('Check start error:', error);
            }
        });
        
        // Progress tracking
        function startProgressTracking() {
            document.getElementById('progressBar').classList.add('active');
            document.getElementById('logContainer').classList.add('active');
            document.getElementById('logContainer').innerHTML = '';
            document.getElementById('resultsSection').style.display = 'none';
            const downloadBtn = document.getElementById('downloadResultsBtn');
            downloadBtn.disabled = true;
            downloadBtn.onclick = null;
            const hint = document.getElementById('resultsHint');
            if (hint) {
                hint.textContent = 'The archive includes the compare.py report and highlighted files.';
            }

            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/status/${currentCheckId}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        // Update progress bar
                        document.getElementById('progressFill').style.width = `${data.progress}%`;
                        document.getElementById('progressFill').textContent = `${data.progress}%`;
                        document.getElementById('progressMessage').textContent = data.message || '';
                        
                        // Add new log entries
                        if (data.new_log_entries && data.new_log_entries.length > 0) {
                            const logContainer = document.getElementById('logContainer');
                            data.new_log_entries.forEach(entry => {
                                const div = document.createElement('div');
                                div.className = 'log-entry';
                                div.textContent = `[${entry.time}] ${entry.message}`;
                                logContainer.appendChild(div);
                                logContainer.scrollTop = logContainer.scrollHeight;
                            });
                        }
                        
                        if (data.status === 'completed' || data.status === 'error') {
                            clearInterval(interval);

                            if (data.status === 'completed') {
                                loadResults(currentCheckId);
                                loadHistory();
                            } else {
                                alert('Check failed. Please check the logs.');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Status check error:', error);
                }
            }, 1000);
        }
        
        // Load results
        async function loadResults(checkId) {
            try {
                activateSection('check');
                const response = await fetch(`/results/${checkId}`);
                const data = await response.json();

                if (data.success) {
                    displayResults(data.results);

                    // Enable download button
                    const downloadBtn = document.getElementById('downloadResultsBtn');
                    if (data.results_available) {
                        downloadBtn.disabled = false;
                        downloadBtn.onclick = () => downloadResults(checkId);
                    } else {
                        downloadBtn.disabled = true;
                        downloadBtn.onclick = null;
                    }
                    loadHistory();
                }
            } catch (error) {
                console.error('Load results error:', error);
            }
        }
        
        function displayResults(results) {
            document.getElementById('resultsSection').style.display = 'block';
            const tbody = document.getElementById('resultsTable');
            tbody.innerHTML = '';

            const hint = document.getElementById('resultsHint');
            if (hint) {
                const matchCount = results.matches ? results.matches.length : 0;
                const summary = matchCount > 0
                    ? `${matchCount} potential match${matchCount > 1 ? 'es' : ''} found.`
                    : 'No matches detected.';
                hint.textContent = `${summary} The archive includes the compare.py report and highlighted files.`;
            }

            if (!results.matches || results.matches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">No plagiarism detected</td></tr>';
                return;
            }
            
            results.matches.forEach(match => {
                const badgeClass = match.similarity > 80 ? 'similarity-high' : 
                                  match.similarity > 60 ? 'similarity-medium' : 'similarity-low';
                
                tbody.innerHTML += `
                    <tr>
                        <td>${match.student1}</td>
                        <td>${match.student2}</td>
                        <td>
                            <span class="similarity-badge ${badgeClass}">
                                ${match.similarity}%
                            </span>
                        </td>
                    </tr>
                `;
            });
        }
        
        // Download results
        async function downloadResults(checkId) {
            window.location.href = `/download/${checkId}`;
        }
        
        // Load history
        async function loadHistory() {
            try {
                const response = await fetch('/history');
                const data = await response.json();
                
                if (data.success) {
                    const tbody = document.getElementById('historyTable');
                    tbody.innerHTML = '';
                    
                    if (data.history.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No history</td></tr>';
                        return;
                    }
                    
                    data.history.forEach(item => {
                        const date = new Date(item.created_at).toLocaleString();
                        const statusBadge = item.status === 'completed' ?
                            '<span class="similarity-badge similarity-low">Completed</span>' :
                            '<span class="similarity-badge similarity-medium">Processing</span>';

                        const viewButton = `<button class="btn btn-primary" onclick="loadResults('${item.check_id}')">View</button>`;
                        const downloadButton = item.results_available
                            ? `<button class="btn btn-success" style="margin-left: 8px;" onclick="downloadResults('${item.check_id}')">Download</button>`
                            : '';
                        const actions = item.status === 'completed' ? `${viewButton}${downloadButton}` : '-';

                        tbody.innerHTML += `
                            <tr>
                                <td>${date}</td>
                                <td>${item.filename || 'Multiple files'}</td>
                                <td>${statusBadge}</td>
                                <td>${item.matches || 0}</td>
                                <td>${actions}</td>
                            </tr>
                        `;
                    });
                }
            } catch (error) {
                console.error('Load history error:', error);
            }
        }
        
        // Admin functions
        async function loadUsers() {
            try {
                const response = await fetch('/admin/users');
                const data = await response.json();

                if (data.success) {
                    const tbody = document.getElementById('usersTable');
                    tbody.innerHTML = '';

                    data.users.forEach(user => {
                        const row = document.createElement('tr');

                        const usernameCell = document.createElement('td');
                        usernameCell.textContent = user.username;
                        row.appendChild(usernameCell);

                        const roleCell = document.createElement('td');
                        roleCell.textContent = user.role;
                        row.appendChild(roleCell);

                        const actionsCell = document.createElement('td');
                        const editButton = document.createElement('button');
                        editButton.className = 'btn btn-secondary';
                        editButton.textContent = 'Edit';
                        editButton.addEventListener('click', () => openUserModal('edit', user));
                        actionsCell.appendChild(editButton);

                        if (user.username !== 'admin') {
                            const deleteButton = document.createElement('button');
                            deleteButton.className = 'btn btn-danger';
                            deleteButton.style.marginLeft = '8px';
                            deleteButton.textContent = 'Delete';
                            deleteButton.addEventListener('click', () => confirmDeleteUser(user));
                            actionsCell.appendChild(deleteButton);
                        }

                        row.appendChild(actionsCell);
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Load users error:', error);
            }
        }

        function showUserModalError(message) {
            const errorEl = document.getElementById('userModalError');
            if (!errorEl) return;
            errorEl.textContent = message || '';
            errorEl.style.display = message ? 'block' : 'none';
        }

        function openUserModal(mode, user) {
            userModalMode = mode;
            editingUserId = user.id || null;
            document.getElementById('userModalTitle').textContent = mode === 'create' ? 'Add User' : 'Edit User';
            document.getElementById('userUsername').value = user.username || '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userRole').value = user.role || 'teacher';
            showUserModalError('');
            document.getElementById('userModal').classList.add('active');
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.remove('active');
            document.getElementById('userPassword').value = '';
        }

        async function confirmDeleteUser(user) {
            if (!confirm(`Delete user "${user.username}"?`)) {
                return;
            }
            try {
                const response = await fetch(`/admin/user/${user.id}`, { method: 'DELETE' });
                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.message || 'Unable to delete user.');
                }
                loadUsers();
            } catch (error) {
                alert(error.message || 'Unable to delete user.');
            }
        }

        document.getElementById('addUserBtn').addEventListener('click', () => {
            openUserModal('create', { username: '', role: 'teacher' });
        });

        document.getElementById('saveUserBtn').addEventListener('click', async () => {
            const username = document.getElementById('userUsername').value.trim();
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;

            if (!username) {
                showUserModalError('Username is required.');
                return;
            }

            if (userModalMode === 'create' && !password) {
                showUserModalError('Password is required for a new user.');
                return;
            }

            try {
                const payload = { username, role };
                if (password) {
                    payload.password = password;
                }

                let response;
                if (userModalMode === 'create') {
                    response = await fetch('/admin/user', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } else {
                    response = await fetch(`/admin/user/${editingUserId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.message || 'Unable to save user.');
                }

                closeUserModal();
                loadUsers();
            } catch (error) {
                showUserModalError(error.message || 'Unable to save user.');
            }
        });

        document.getElementById('cancelUserBtn').addEventListener('click', () => {
            closeUserModal();
        });
        
        // Library management
        async function loadLibraryTree() {
            try {
                const response = await fetch('/admin/library/tree');
                const data = await response.json();
                
                if (data.success) {
                    displayLibraryTree(data.tree);
                }
            } catch (error) {
                // If endpoint doesn't exist yet, show placeholder
                document.getElementById('libraryTree').innerHTML = '<p style="color: #666;">Library tree will be displayed here</p>';
            }
        }
        
        function displayLibraryTree(tree) {
            // Display tree structure
            const container = document.getElementById('libraryTree');
            container.innerHTML = buildTreeHTML(tree);
        }
        
        function buildTreeHTML(items, level = 0) {
            // Build tree HTML recursively
            let html = '';
            items.forEach(item => {
                if (item.type === 'folder') {
                    html += `<div class="tree-folder" style="margin-left: ${level * 20}px">${item.name}</div>`;
                    if (item.children) {
                        html += buildTreeHTML(item.children, level + 1);
                    }
                } else {
                    html += `<div class="tree-file" style="margin-left: ${level * 20}px">${item.name}</div>`;
                }
            });
            return html;
        }
        
        document.getElementById('libraryFileInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                
                await fetch('/admin/library/upload', {
                    method: 'POST',
                    body: formData
                });
            }
            loadLibraryTree();
            loadDashboard(); // Refresh dashboard
        });
        
        document.getElementById('refreshLibraryBtn').addEventListener('click', () => {
            loadLibraryTree();
            loadDashboard();
        });
        
        // Initialize
        checkSession();
    </script>
</body>
</html>